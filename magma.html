<!DOCTYPE html>
    <head>
        <meta charset=utf-8>
        <script>
    MathJax = {
        loader: {load: ['[tex]/mathtools', '[tex]/html', '[tex]/newcommand', '[tex]/textmacros']},
        startup: {
            pageReady: () => {
                return MathJax.startup.defaultPageReady().then(() => {
                    const loading_screen = document.getElementById("loading_screen");
                    loading_screen.style.display = 'none';
                });
            }
        },
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            packages: {'[+]': ['mathtools', 'html', 'newcommand', 'textmacros']},
        },
        options: {
            skipHtmlTags: {'[-]': ['code', 'pre']},
        }
    };
    </script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
    </script>
    
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&display=swap" rel="stylesheet">
        <style>
            html, body, div, span, applet, object, iframe,
        h1, h2, h3, h4, h5, h6, p, blockquote, pre,
        a, abbr, acronym, address, big, cite, code,
        del, dfn, em, img, ins, kbd, q, s, samp,
        small, strike, strong, sub, sup, tt, var,
        b, u, i, center,
        dl, dt, dd, ol, ul, li,
        fieldset, form, label, legend,
        table, caption, tbody, tfoot, thead, tr, th, td,
        article, aside, canvas, details, embed,
        figure, figcaption, footer, header, hgroup,
        menu, nav, output, ruby, section, summary,
        time, mark, audio, video {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 100%;
            font: inherit;
            vertical-align: baseline;
        }
        /* HTML5 display-role reset for older browsers */
        article, aside, details, figcaption, figure,
        footer, header, hgroup, menu, nav, section {
            display: block;
        }
        body {
            line-height: 1;
        }
        ol, ul {
            list-style: none;
        }
        blockquote, q {
            quotes: none;
        }
        blockquote:before, blockquote:after,
        q:before, q:after {
            content: '';
            content: none;
        }
        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        h1, h2, h3, h4 {
            font-family: 'Open Sans', sans-serif;
            font-weight: 700;
        }

        body {
            font-family: 'Merriweather', serif;
            text-align: justify;
        }

        body {
            margin:5% auto;
            max-width: 35em;
            padding:0 .6em;
            font-size: 16pt;
            line-height: 1.3;
            color: #000;
            background: #fff;
        }

        p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .assumptions + p {
            margin-top: 0em;
        }

        ul, ol, dl {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        ul {
            list-style-type: disc;
        }

        li {
            margin-left: 2.5em;
            margin-top: 0.2em;
            margin-bottom: 0.2em;
        }

        pre {
            font-family: monospace;
        }

        h1 {
            margin-bottom: 0.5em;
            font-size: 36pt;
            text-align: center;
            line-height: 1.6;
        }

        #subtitle {
            text-align: center;
            margin-bottom: 4em;
        }

        h2 {
            margin-bottom: 1em;
            font-size: 28pt;
            text-align: center;
        }

        .chapterNumber.chapterHeading {
            margin-top: 3em;
            margin-bottom: 0.5em;
            font-family: 'Open Sans', sans-serif;
            font-weight: 700;
            font-size: 22pt;
            text-align: center;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .ref {
            border-bottom: dotted 1px #a0a0a0;
        }

        h3 {
            margin-top: 1.5em;
            margin-bottom: 1em;
            font-size: 22pt;
        }

        h4 {
            margin-top: 1.5em;
            margin-bottom: 1em;
            font-size: 20pt;
        }

        em, i {
            font-style: italic;
        }

        .literal::before {
            content: "“";
        }

        .literal::after {
            content: "”";
        }

        .defined {
            color: rgb(124, 0, 132);
            font-weight: bold;
        }

        .comment {
            color: #6e6e6e;
            font-style: italic;
            font-family: monospace;
        }

        .comment::before {
            content: "# ";
        }

        .box {
            margin-top: 1em;
            margin-bottom: 1em;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            padding-right: 1em;
            padding-left: 1em;
        }

        aside {
            border: solid;
            border-radius: 1em;
            color: #00529b;
            background-color: #bde5f8;
        }

        .programming {
            color: #7f0099;
            background-color: #ffb5f9;
        }

        .statement {
            
                    margin-top: 1.5em;
                    margin-bottom: 1.5em;
                    padding-top: 0.5em;
                    padding-bottom: 0.5em;
                    padding-right: 1em;
                    padding-left: 1em;
                    background:
                        linear-gradient(to left, #e33900 0em, #e33900 2em, transparent 2em) 0 100% / 100% 3px no-repeat,
                        linear-gradient(to right, #e33900 0em, #e33900 2em, transparent 2em) 0 0 / 100% 3px no-repeat,
                        linear-gradient(to bottom, #e33900 0em, #e33900 2em, transparent 2em) 0 0 / 3px 100% no-repeat,
                        linear-gradient(to top, #e33900 0em, #e33900 2em, transparent 2em) 100% 0 / 3px 100% no-repeat,
                        #fff
        }

        .definition {
            
                    margin-top: 1.5em;
                    margin-bottom: 1.5em;
                    padding-top: 0.5em;
                    padding-bottom: 0.5em;
                    padding-right: 1em;
                    padding-left: 1em;
                    background:
                        linear-gradient(to left, rgb(124, 0, 132) 0em, rgb(124, 0, 132) 2em, transparent 2em) 0 100% / 100% 3px no-repeat,
                        linear-gradient(to right, rgb(124, 0, 132) 0em, rgb(124, 0, 132) 2em, transparent 2em) 0 0 / 100% 3px no-repeat,
                        linear-gradient(to bottom, rgb(124, 0, 132) 0em, rgb(124, 0, 132) 2em, transparent 2em) 0 0 / 3px 100% no-repeat,
                        linear-gradient(to top, rgb(124, 0, 132) 0em, rgb(124, 0, 132) 2em, transparent 2em) 100% 0 / 3px 100% no-repeat,
                        #fff
        }

        .exercise {
            
                    margin-top: 1.5em;
                    margin-bottom: 1.5em;
                    padding-top: 0.5em;
                    padding-bottom: 0.5em;
                    padding-right: 1em;
                    padding-left: 1em;
                    background:
                        linear-gradient(to left, #00c5e3 0em, #00c5e3 2em, transparent 2em) 0 100% / 100% 3px no-repeat,
                        linear-gradient(to right, #00c5e3 0em, #00c5e3 2em, transparent 2em) 0 0 / 100% 3px no-repeat,
                        linear-gradient(to bottom, #00c5e3 0em, #00c5e3 2em, transparent 2em) 0 0 / 3px 100% no-repeat,
                        linear-gradient(to top, #00c5e3 0em, #00c5e3 2em, transparent 2em) 100% 0 / 3px 100% no-repeat,
                        #fff
        }

        .example {
            
                    margin-top: 1.5em;
                    margin-bottom: 1.5em;
                    padding-top: 0.5em;
                    padding-bottom: 0.5em;
                    padding-right: 1em;
                    padding-left: 1em;
                    background:
                        linear-gradient(to left, rgb(0, 156, 28) 0em, rgb(0, 156, 28) 2em, transparent 2em) 0 100% / 100% 3px no-repeat,
                        linear-gradient(to right, rgb(0, 156, 28) 0em, rgb(0, 156, 28) 2em, transparent 2em) 0 0 / 100% 3px no-repeat,
                        linear-gradient(to bottom, rgb(0, 156, 28) 0em, rgb(0, 156, 28) 2em, transparent 2em) 0 0 / 3px 100% no-repeat,
                        linear-gradient(to top, rgb(0, 156, 28) 0em, rgb(0, 156, 28) 2em, transparent 2em) 100% 0 / 3px 100% no-repeat,
                        #fff
        }

        h5 {
            font-weight: 700;
            margin-top: 0.5em;
        }

        .proof:before {
            content: "Proof:";
            font-style: italic;
        }

        .infoheader, .programmingheader {
            border-bottom: solid 1px;
        }

        .infoheader:before {
            content:"By the way:";
        }

        .programmingheader:before {
            content: "For programmers:";
        }

        .citation {
            color: #0000EE;
        }

        .citation:before {
            content: "[";
            color: #000;
        }

        .citation:after {
            content: "]";
            color: #000;
        }

        ul.references {
            list-style-type: none;
        }

        ul.references li {
            margin-bottom: 1em;
            margin-left: 0em;
        }

        .sourceMeta {
            margin-left: 1em;
        }

        ul.cases {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            list-style-type: none;
        }

        ul.cases li {
            margin-left: 0em;
        }

        .caseNumbering {
            font-weight: 700;
        }

        .caseBody {
            margin-left: 1em;
        }

        .inline {
            display: Inline;
        }

        .type_body {
            margin-left: 3em;
        }

        .type_field:after {
            content: ",";
        }

        .outlink {
            border: none;
            text-decoration: underline;
            color: #0000EE;
        }

        .step_btn {
            display: inline-block;
            margin-top: 1em;
            margin-right: 3em;
            padding-left: 0.5em;
            padding-right: 0.5em;
            padding-top: 0.3em;
            padding-bottom: 0.3em;
            font-family: 'Open Sans', sans-serif;
            border: solid;
            border-radius: 4pt;
            color: #00529b;
            background-color: #bde5f8;
            cursor: pointer;
            transition: color .2s ease;
            transition: background-color .2s ease;
        }

        .step_btn:hover {
            color: #0074db;
            background-color: #e4f6ff;
        }

        .step_btn.inactive {
            cursor: not-allowed;
            color: #00529b;
            background-color: #bde5f8;
        }

        svg {
            font-family: 'Open Sans', sans-serif;
            border: solid;
            border-radius: 4px;
        }

        /* from https://loading.io/css/ */
        .lds-dual-ring {
            display: inline-block;
            width: 80px;
            height: 80px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 64px;
            height: 64px;
            margin: 8px;
            border-radius: 50%;
            border: 6px solid #000;
            border-color: #000 transparent #000 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
            .skiplink {
        stroke: black;
        fill: black;
    }

    .predecessorlink {
        stroke: black;
        fill: black;
    }

    .skiplinkarclink {
        stroke: black;
        fill: none;
    }

    #skiplinkhead {
        fill: black;
    }

    .chapterNumber {
        display: none;
    }
        </style>
    </head>
    <body>
        <div id="loading_screen" style="position:fixed;
      top:0;
      left:0;
      background: #ffffff;
      z-index:5;
      width:100%;
      height:100%;
      display: flex;
  justify-content: center;
  align-items: center;">
      <div>
        <h1><h1>Magma</h1></h1>
        <h2>Rendering formulae <div class="lds-dual-ring"></div></h2>
    </div>
    </div>
        <h1>Magma</h1>
        $\newcommand{\value}[1]{\mathrm{#1}}
    \newcommand{\constructor}[1]{\mathrm{#1}}
    \newcommand{\type}[1]{\mathit{#1}}
    \newcommand{\field}[1]{\mathit{#1}}
    \newcommand{\access}[2]{{#1}.\kern-.15em{#2}}
    \newcommand{\var}[1]{\class{var #1}{#1}}
    \newcommand{\fun}[3]{{#1}: {#2} \rightarrow {#3}}
    \newcommand{\defeq}[0]{\coloneqq}
    \newcommand{\N}[0]{\mathbb{N}}
    \newcommand{\Np}[0]{{\mathbb{N}^{+}}}
    \newcommand{\Z}[0]{\mathbb{Z}}
    \newcommand{\Zp}[0]{{\mathbb{Z}^{+}}}
    \newcommand{\set}[1]{\left\{#1\right\}}
    \newcommand{\sequence}[1]{\left(#1\right)}
    \newcommand{\ceil}[1]{\left\lceil#1\right\rceil}
    \newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}
    \newcommand{\abs}[1]{\left|#1\right|}
    \newcommand{\powerset}[1]{\mathcal{P}({#1})}
    \newcommand{\kleene}[1]{{#1}^{\ast}}
    \newcommand{\bit}[0]{\set{0, 1}}
    \newcommand{\bitstring}[0]{\kleene{\bit}}
    \newcommand{\complexity}[1]{\mathcal{O}({#1})}
    \newcommand{\groupAdd}[0]{+}
    \newcommand{\groupZero}[0]{0}
    \newcommand{\nil}[0]{\mathtt{nil}}

    \newcommand{\UnsignedInteger}[1]{\set{0, \ldots, 2^{#1} - 1}}

    \DeclareMathOperator{\lbl}{lbl}
    \DeclareMathOperator{\enc}{enc}
    \DeclareMathOperator{\discriminatedUnion}{\cup}
        $
        <p>Magma is a protocol for immutably storing snapshots of values which evolve over time, in a way that enables efficient updates from one value to a later one even if the source providing the update data cannot compute what changed between any two values. That is quite a mouthful, so we begin with an extended description of the problem that magma aims to solve.</p>
<section class="section">
            <h3><a id="introduction" href="#introduction">Introduction</a></h3>
        <p>Consider a data source producing a sequence of values. These values might be large, but any new value can be obtained from the preceding value through a small change — we can think of the sequence as describing a single, mutable variable changing over time.</p>
<p>The sequence is read by a server, which stores enough data to be able to reconstruct the value of the variable at any point of its evolution. The easiest way of accomplishing this is to store the full sequence of values, but other options exist.</p>
<p>Now consider a client that knows the value of the variable at a certain point of time, has obtained the identifier of a more recent value from a trusted source, and now wants to obtain that value from the server. There are some trivial strategies, but all of them are problematic:</p>
<ul>
                    <li>If the server stores the full sequence of values, it can simply send the requested value to the client. This does not however utilize in any way that the client already knows an older value. As we assume values to be large and changes to be small, this is efficient.</li>
                    <li>If the server stores the full sequence of values, it could compute what changed between the client's old value and the requested value. This preserve bandwidth, but requires (potentially high) computational resources on the server. Furthermore, if the data is authenticated by the data source, the server cannot reauthenticate the computed change. Or if the data is encrypted, the server cannot perform the computation in the first place.</li>
                    <li>If the data source publishes the sequence as a sequence of changes compared to each preceding sequence item, the server can also store that sequence of changes. The client can then be given the subsequence of changes leading from its old value to the requested value. This list can however get very long, and if some of the changes cancel each other out, it becomes cluttered with ultimately useless information.</li>
                    <li>If the data source published the sequence by providing the change from each new value to every old value, the server could send exactly the right data to the client. However, the amount of data would grow quadratically.</li>
                </ul>
<p>Magma provides a more efficient trade-off between these extremes, by employing <a href="https://aljoscha-meyer.de/linkingschemes" class="outlink">binary anti-monotone linking schemes</a>. It further uses <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function" class="outlink">secure hashes</a> to ensure that the server party need not be trusted by either the data source or the client.</p>
</section>
<section class="section">
            <h3><a id="evolving_values" href="#evolving_values">Evolving Values</a></h3>
        <p>We begin by examining how a data source can publish values such that clients can efficiently obtain updates from a server without requiring the server to be able to perform computations on the values. The magma protocol itself is introduced later.</p>
<p>The approach that magma uses applies to a wider class of data structures than the sequences from the introduction. We consider values with at most one preceding value, or in other words, forests of rooted trees labeled with changes. Or yet another viewpoint: we consider sets of sequences that may share a common past (i.e., a common prefix).</p>
<div id="labeled_forest" class="definition">
<h5><a href="#labeled_forest">Definition <span class="chapterNumber">0.</span>1: Labeled In-Forest</a></h5><div class="assumptions">Let $S$ be a set, $G = (V, A)$ a directed graph, and $\fun{\lbl}{V}{S}$ a function.</div><p>We call the pair $\sequence{G, \lbl}$ a <a href="#labeled_forest" class="defined">labeled in-forest</a> if $G$ is a forest of rooted trees with all edges oriented toward the roots.</p>
</div>
<div id="example_labeled_forest" class="example">
<h5><a href="#example_labeled_forest">Example <span class="chapterNumber">0.</span>2</a></h5><p>The following figure shows an example <a href="#labeled_forest" class="ref">labeled in-forest</a>.</p>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="-0.5 -0.5 7.5 3" id="figure_example_labeled_forest"><defs><marker id="predecessorhead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="predecessorlink"/></marker><marker id="skiphead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="skiplink"/></marker><marker id="skiplinkarchead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="skiplinkarclinkk"/></marker></defs><g><text x="1" y="1" class="24" font-size="0.2" text-anchor="middle" dominant-baseline="middle">24</text><text x="2" y="1" class="29" font-size="0.2" text-anchor="middle" dominant-baseline="middle">29</text><text x="3" y="1" class="29" font-size="0.2" text-anchor="middle" dominant-baseline="middle">29</text><text x="4" y="1.5" class="30" font-size="0.2" text-anchor="middle" dominant-baseline="middle">30</text><text x="4" y="0.5" class="47" font-size="0.2" text-anchor="middle" dominant-baseline="middle">47</text><text x="5" y="1.5" class="28" font-size="0.2" text-anchor="middle" dominant-baseline="middle">28</text><text x="5" y="0.5" class="40" font-size="0.2" text-anchor="middle" dominant-baseline="middle">40</text><text x="6" y="1.5" class="34" font-size="0.2" text-anchor="middle" dominant-baseline="middle">34</text><line x1="1.8" y1="1" x2="1.2" y2="1" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="2.8" y1="1" x2="2.2" y2="1" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="3.821114561800017" y1="1.4105572809000084" x2="3.178885438199983" y2="1.0894427190999916" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="3.821114561800017" y1="0.5894427190999916" x2="3.178885438199983" y2="0.9105572809000084" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="4.8" y1="1.5" x2="4.2" y2="1.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="4.8" y1="0.5" x2="4.2" y2="0.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><line x1="5.8" y1="1.5" x2="5.2" y2="1.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line></g></svg>
</div>
<p>We now wish to find a data structure that allows to efficiently reconstruct a <a href="#labeled_forest" class="ref">labeled in-forest</a> by applying a series of changes. To obtain an efficient solution, we require that the grouping of how changes are applied is irrelevant (notice that the order of changes must however remain unchanged), this is captured in the concept of a <a href="https://en.wikipedia.org/wiki/Semigroup" class="outlink">semigroup</a>.</p>
<div id="semigroup" class="definition">
<h5><a href="#semigroup">Definition <span class="chapterNumber">0.</span>3: Semigroup</a></h5><p>A <a href="#semigroup" class="defined">semigroup</a> is a pair $\sequence{S, \groupAdd}$ of a set $S$ and a function $\fun{\groupAdd}{S \times S}{S}$ satisfying:</p>
<ul>
                            <li><a id="semigroup_associativity" href="#semigroup_associativity" class="defined">associativity</a>: For all $x, y, z \in S$ it holds that $(x \groupAdd y) \groupAdd z = x \groupAdd (y \groupAdd z)$.</li>
                        </ul>
</div>
<p>The core idea now is to create a graph describing the changes between different values in a <a href="#labeled_forest" class="ref">labeled in-forest</a>. <a href="https://aljoscha-meyer.de/linkingschemes#bamls" class="ref">Binary anti-monotone linking schemes</a> have short paths between any pair of vertices, labeling the arcs of a <a href="https://aljoscha-meyer.de/linkingschemes#bamls" class="ref">binary anti-monotone linking scheme</a> allows to efficiently reconstruct the accumulated changes. <a href="#semigroup_associativity" class="ref">Associativity</a> ensures that accumulating along <a href="https://aljoscha-meyer.de/linkingschemes#skip_link" class="ref">skip links</a> leads to the same results as accumulating along <a href="https://aljoscha-meyer.de/linkingschemes#predecessor_link" class="ref">predecessor links</a>. Formally:</p>
<div id="forest_notation" class="definition">
<h5><a href="#forest_notation">Definition <span class="chapterNumber">0.</span>4: Notation</a></h5><div class="assumptionsmulti">Let $G = (V, A)$ be a forest of rooted trees with all arcs oriented toward the roots, and let $v, u \in V$.</div><p>$\DeclareMathOperator{\depthVanilla}{depth}\newcommand{\depth}[2]{\href{##forest_notation}{\depthVanilla}_{#2}({#1})}$The <a id="depth" href="#depth" class="defined">depth</a> of $v$, written $\depth{v}{G}$, is the length of the path from $v$ to its root ($0$ in case $v$ is a root itself).</p>
<p>$\newcommand{\ancestor}[1]{\href{##forest_notation}{\leq}_{#1}}$We write $u \ancestor{G} v$ if there is a path from $v$ to $u$.</p>
</div>
<div id="evolution" class="definition">
<h5><a href="#evolution">Definition <span class="chapterNumber">0.</span>5: Evolution</a></h5><div class="assumptionsmulti">$\newcommand{\associatedGraph}[1]{\href{https://aljoscha-meyer.de/linkingschemes##associated_graph}{G}_{#1}}$Let $\mathcal{S} = \sequence{S, \groupAdd}$ be a <a href="#semigroup" class="ref">semigroup</a>, $\mathcal{F} = \sequence{G = \sequence{V, A}, \fun{\lbl}{V}{S}}$ a <a href="#labeled_forest" class="ref">labeled in-forest</a>, and $\fun{f}{\Np}{\Np}$ be a function such that $\associatedGraph{f}$ is a <a href="https://aljoscha-meyer.de/linkingschemes#bamls" class="ref">binary anti-monotone linking scheme</a>.</div><p>$\newcommand{\evolution}[3]{{#1}_{\sequence{{#2}, {#3}}}}$An $\sequence{f, \mathcal{S}}$-<a id="evolution" href="#evolution" class="defined">evolution</a> of $\mathcal{F}$ is an arc-labeled directed graph $\evolution{E}{f}{\mathcal{S}} \defeq \sequence{\evolution{G}{f}{\mathcal{S}} = (\evolution{V}{f}{\mathcal{S}}, \evolution{A}{f}{\mathcal{S}}), \evolution{\lbl}{f}{\mathcal{S}}}$, such that:</p>
<p>$\begin{align*}
                        \evolution{V}{f}{\mathcal{S}} &\defeq V \discriminatedUnion \set{\nil},\\
                        \evolution{A}{f}{\mathcal{S}} &\defeq A \cup \set{\sequence{\nil, v} \mid \text{$v \in V$ and $\depth{v}{G} = 0$}}\\
                        &\cup \{\sequence{u, v} \mid u, v \in V, u \ancestor{G} v,\\
                        &\text{\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;and $\depth{u}{G} + 1 = f(\depth{v}{G} + 1)$}\},\\
                        \end{align*}$</p>
<p>and for all $\sequence{v, u} \in \evolution{A}{f}{\mathcal{S}}$, $\lbl(u) \groupAdd \evolution{\lbl}{f}{\mathcal{S}}(\sequence{v, u}) = \lbl(v)$.</p>
</div>
<div id="example_evolution" class="example">
<h5><a href="#example_evolution">Example <span class="chapterNumber">0.</span>6</a></h5><p>$\DeclareMathOperator{\lsTwoVanilla}{ls_{2}}\newcommand{\lstwo}[0]{\href{https://aljoscha-meyer.de/linkingschemes##lstwo}{\lsTwoVanilla}}$The following figure shows the unique $\sequence{\lstwo, \mathcal{Z}}$-<a href="#evolution" class="ref">evolution</a> of <a href="#example_labeled_forest" class="ref">Example&#xA0;<span class="chapterNumber">0.</span>2</a>, where $\mathcal{Z} \defeq \sequence{\Z, +}$ is the additive <a href="#semigroup" class="ref">semigroup</a> of integers. Notice how adding up the arc labels along any path from a vertex to the root yields the label of that vertex in <a href="#example_labeled_forest" class="ref">Example&#xA0;<span class="chapterNumber">0.</span>2</a>.</p>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="-0.5 -0.5 7.5 3" id="figure_example_evolution"><defs><marker id="predecessorhead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="predecessorlink"/></marker><marker id="skiphead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="skiplink"/></marker><marker id="skiplinkarchead" viewBox="0 0 15 15" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="skiplinkarclinkk"/></marker></defs><g><circle cx="0" cy="1" r="0.1"/><circle cx="1" cy="1" r="0.1"/><circle cx="2" cy="1" r="0.1"/><circle cx="3" cy="1" r="0.1"/><circle cx="4" cy="1.5" r="0.1"/><circle cx="4" cy="0.5" r="0.1"/><circle cx="5" cy="1.5" r="0.1"/><circle cx="5" cy="0.5" r="0.1"/><circle cx="6" cy="1.5" r="0.1"/><line x1="0.8" y1="1" x2="0.2" y2="1" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="0.5" y="0.88" class="24" text-anchor="middle" dominant-baseline="middle" font-size="0.2">24</text><line x1="1.8" y1="1" x2="1.2" y2="1" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="1.5" y="0.88" class="5" text-anchor="middle" dominant-baseline="middle" font-size="0.2">5</text><line x1="2.8" y1="1" x2="2.2" y2="1" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="2.5" y="0.88" class="0" text-anchor="middle" dominant-baseline="middle" font-size="0.2">0</text><line x1="3.821114561800017" y1="1.4105572809000084" x2="3.178885438199983" y2="1.0894427190999916" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="3.5" y="1.13" class="1" text-anchor="middle" dominant-baseline="middle" font-size="0.2">1</text><line x1="3.821114561800017" y1="0.5894427190999916" x2="3.178885438199983" y2="0.9105572809000084" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="3.5" y="0.63" class="18" text-anchor="middle" dominant-baseline="middle" font-size="0.2">18</text><line x1="4.8" y1="1.5" x2="4.2" y2="1.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="4.5" y="1.38" class="-2" text-anchor="middle" dominant-baseline="middle" font-size="0.2">-2</text><line x1="4.8" y1="0.5" x2="4.2" y2="0.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="4.5" y="0.38" class="-7" text-anchor="middle" dominant-baseline="middle" font-size="0.2">-7</text><line x1="5.8" y1="1.5" x2="5.2" y2="1.5" class="predecessorlink" marker-end="url(#predecessorhead)" stroke-width="0.02"></line><text x="5.5" y="1.38" class="6" text-anchor="middle" dominant-baseline="middle" font-size="0.2">6</text><path d="M 2.8585786437626903 0.8585786437626904 Q 2 0 1.1414213562373094 0.8585786437626904" class="skiplinkarclink" marker-end="url(#skiplinkarchead)" stroke-width="0.02"></path><text x="2" y="0.25" class="5" text-anchor="middle" dominant-baseline="middle" font-size="0.2">5</text><path d="M 5.828501414857491 1.6028991510855053 Q 3.5 3 3.0485071250072666 1.1940285000290665" class="skiplinkarclink" marker-end="url(#skiplinkarchead)" stroke-width="0.02"></path><text x="4.1" y="2" class="5" text-anchor="middle" dominant-baseline="middle" font-size="0.2">5</text></g></svg>
</div>
<p>If a server stores an <a href="#evolution" class="ref">evolution</a> and a client wants to update a value, the server can answer with the arc labels along the shortest path between the requested value and the clients old value.</p>
<p>Because we consider settings where server does not perform any computation on the data it serves, the data source has to publish data in the correct form. More specifically, an update to the <a href="#labeled_forest" class="ref">labeled in-forest</a> produced by a data source must include the following information: the new vertex $v$, the predecessor vertex $p$, the change from the predecessor $\evolution{\lbl}{f}{\mathcal{S}}(\sequence{v, p})$, the <a href="https://aljoscha-meyer.de/linkingschemes#skip_link" class="ref">skip link</a> vertex $s$, and the change from that vertex $\evolution{\lbl}{f}{\mathcal{S}}(\sequence{v, s})$.</p>
<p>This concludes an abstract description of how magma solves the problem of providing incremental updates through untrusted intermediaries. The next section introduces the magma protocol proper, going into specifics of, e.g., the question of how peers can identify vertices, or how clients can be protected from servers feeding them garbage data.</p>
</section>
<section class="section">
            <h3><a id="magma_events" href="#magma_events">Magma Events</a></h3>
        <p>$\newcommand{\h}[0]{\href{##h}{h}}\newcommand{\digest}[0]{\href{##digest}{\type{Digest}}}$Working with <a href="#evolution" class="ref">evolutions</a> requires the ability to compactly reference pieces of data. Magma uses <a href="https://en.wikipedia.org/wiki/Content-addressable_storage" class="outlink">content-based addressing</a>, the reference to a datum consists of the digest of a <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function" class="outlink">cryptographic hash function</a> of that datum. Magma is generic over which hash function is used, an instantiation of the protocol must specify one. In the following text, we write $\cssId{h}{\fun{\h}{\bitstring}{\digest}}$ for that function, with $\cssId{digest}{\digest}$ being the set of bit-strings of some fixed length.</p>
<p>$\newcommand{\SM}[0]{\href{##Sm}{\mathcal{S}}}\newcommand{\S}[0]{\href{##S}{S}}\newcommand{\sAdd}[0]{\href{##s_add}{\groupAdd}}\newcommand{\encS}[0]{\href{##encS}{\enc_{\S}}}\newcommand{\EncS}[0]{\href{##EncS}{\type{Enc}_{\S}}}$An instantiation of magma must also specify the <a href="#semigroup" class="ref">semigroup</a> of the values, we write $\cssId{SM}{\SM} = \sequence{\cssId{S}{\S}, \cssId{s_add}{\sAdd}}$ for it. Furthermore, it must be possible to encode values as bit-strings, an instantiation must specify an injective encoding function $\fun{\cssId{encS}{\encS}}{\S}{\EncS}$ with $\cssId{EncS}{\EncS} \subseteq \bitstring$.</p>
<p>$\DeclareMathOperator{\lsThreeVanilla}{ls_{3}}\newcommand{\lsthree}[0]{\href{https://aljoscha-meyer.de/linkingschemes##lsthree}{\lsThreeVanilla}}$Magma uses $\lsthree$ as its linking scheme.</p>
<p>With these parameters fixed, we can now define magma events, the data published by a data source:</p>
<div id="magma_event" class="definition">
<h5><a href="#magma_event">Definition <span class="chapterNumber">0.</span>7: Magma Event</a></h5><p>A <a href="#magma_event" class="defined">magma event</a> is an instance of the following datatype:</p>
$\newcommand{\magmaEvent}[0]{\href{##magma_event_type}{\type{MagmaEvent}}}\newcommand{\rootEvent}[0]{\href{##root_event}{\constructor{RootEvent}}}\newcommand{\predChangeRoot}[0]{\href{##pred_change_root}{\field{\delta_S}}}\newcommand{\predLengthRoot}[0]{\href{##pred_length_root}{\field{\delta_{\mathit{len}}}}}\newcommand{\childEvent}[0]{\href{##child_event}{\constructor{ChildEvent}}}\newcommand{\depth}[0]{\href{##event_depth}{\field{depth}}}\newcommand{\pred}[0]{\href{##pred}{\field{\delta}}}\newcommand{\predChange}[0]{\href{##pred_change}{\field{\delta_S}}}\newcommand{\predLength}[0]{\href{##pred_length}{\field{\delta_{\mathit{len}}}}}\newcommand{\skip}[0]{\href{##skip}{\field{\Delta}}}\newcommand{\skipChange}[0]{\href{##skip_change}{\field{\Delta_S}}}\newcommand{\skipLength}[0]{\href{##skip_length}{\field{\Delta_{\mathit{len}}}}}$<div class="comment">Describes a vertex in an <a href="#evolution" class="ref">evolution</a>.</div>enum $\cssId{magma_event_type}{\magmaEvent}$ {<div class="type_body"><div class="comment">A vertex whose predecessor is $\nil$.</div>$\cssId{root_event}{\rootEvent}$ {<div class="type_body"><div class="comment">The hash of the encoding of the data change from $\nil$.</div><div class="type_field">$\cssId{pred_change_root}{\predChangeRoot}$: $\digest$</div><div class="comment">The size of the encoding of the data change from $\nil$.</div><div class="type_field">$\cssId{pred_length_root}{\predLengthRoot}$: $\UnsignedInteger{64}$</div></div>}<div class="comment">A vertex whose predecessor is not $\nil$.</div>$\cssId{child_event}{\childEvent}$ {<div class="type_body"><div class="comment">The <a href="#depth" class="ref">depth</a> of the vertex.</div><div class="type_field">$\cssId{event_depth}{\depth}$: $\set{2, \ldots, 2^{64} - 1}$</div><div class="comment">The hash of the encoding of the event of the <a href="https://aljoscha-meyer.de/linkingschemes#predecessor_link" class="ref">predecessor link</a> vertex.</div><div class="type_field">$\cssId{pred}{\pred}$: $\digest$</div><div class="comment">The hash of the encoding of the data change from $\pred$.</div><div class="type_field">$\cssId{pred_change}{\predChange}$: $\digest$</div><div class="comment">The size of the encoding of the data change from $\pred$.</div><div class="type_field">$\cssId{pred_length}{\predLength}$: $\UnsignedInteger{64}$</div><div class="comment">The hash of the encoding of the event of the <a href="https://aljoscha-meyer.de/linkingschemes#skip_link" class="ref">skip link</a> vertex.</div><div class="type_field">$\cssId{skip}{\skip}$: $\digest$</div><div class="comment">The hash of the encoding of the data change from $\skip$.</div><div class="type_field">$\cssId{skip_change}{\skipChange}$: $\digest$</div><div class="comment">The size of the encoding of the data change from $\skip$.</div><div class="type_field">$\cssId{skip_length}{\skipLength}$: $\UnsignedInteger{64}$</div></div>}</div>}
</div>
<p>The 64-bit integers used for $\depth$, $\predLength$, and $\skipLength$ limit which <a href="#evolution" class="ref">evolutions</a> can be represented: neither the <a href="#depth" class="ref">depth</a> of any vertex nor the size of the encoding of a <a href="#semigroup" class="ref">semigroup</a> value may exceed $2^{64} - 1$.</p>
<p>Because <a href="#magma_event" class="ref">magma events</a> reference each other via hashes, we have to specify a way of encoding them:</p>
<div id="magma_event_encoding" class="definition">
<h5><a href="#magma_event_encoding">Definition <span class="chapterNumber">0.</span>8: Event Encoding</a></h5><p>$\newcommand{\eventEncoding}[1]{\href{##magma_event_encoding}{\enc_{\value{event}}}({#1})}$The <a id="magma_event_encoding" href="#magma_event_encoding" class="defined">event encoding</a> $\eventEncoding{e}$ of a <a href="#magma_event" class="ref">magma event</a> $e$ is a bit-string defined as follows:<ul>
                            <li>If $e$ is a $\rootEvent$, the encoding consists of a zero-byte, followed by $\access{e}{\predChange}$, followed by $\access{e}{\predLength}$ encoded as a canonic <a href="https://github.com/AljoschaMeyer/varu64" class="outlink">VarU64</a>.</li>
                            <li>If $e$ is a $\childEvent$, the encoding consists of $\access{e}{\depth}$ encoded as a canonic <a href="https://github.com/AljoschaMeyer/varu64#non-zero-unsigned-integers" class="outlink">VarNonZeroU64</a>, followed by $\access{e}{\pred}$, followed by $\access{e}{\predChange}$, followed by $\access{e}{\predLength}$ encoded as a canonic <a href="https://github.com/AljoschaMeyer/varu64" class="outlink">VarU64</a>. If $\pred \neq \skip$, then this is followed by $\access{e}{\skip}$, followed by $\access{e}{\skipChange}$, followed by $\access{e}{\skipLength}$ encoded as a canonic <a href="https://github.com/AljoschaMeyer/varu64" class="outlink">VarU64</a>.</li>
                        </ul></p>
</div>
<p>We can now formalize the intuitive comments of <a href="#magma_event" class="ref">Definition&#xA0;<span class="chapterNumber">0.</span>7</a> by defining a mapping from the vertices of an <a href="#evolution" class="ref">evolution</a> to <a href="#magma_event" class="ref">magma events</a>.</p>
<div id="event_meaning" class="definition">
<h5><a href="#event_meaning">Definition <span class="chapterNumber">0.</span>9</a></h5><div class="assumptionsmulti">Let $\evolution{E}{\lsthree}{\SM} = \sequence{\evolution{G}{\lsthree}{\SM} = (\evolution{V}{\lsthree}{\SM}, \evolution{A}{\lsthree}{\mathcal{S}}), \evolution{\lbl}{\lsthree}{\SM}}$ be an <a href="#evolution" class="ref">evolution</a>, and let $v \in \evolution{V}{f}{\SM} \setminus \set{\nil}$.</div><p>$\DeclareMathOperator{\eventVanilla}{event}\newcommand{\event}[1]{\href{##event_meaning}{\eventVanilla}_{#1}}$The <a href="#magma_event" class="ref">magma event</a> $\event{v}$ is defined as follows:</p>
<p>If $\depth{\evolution{G}{f}{\mathcal{S}}}(v) = 1$, then:</p>
$\event{v} \defeq$ $\rootEvent$ {<div class="type_body"><div class="type_field">$\predChangeRoot$: $\h(\encS(\evolution{\lbl}{f}{\mathcal{S}}(\sequence{v, \nil})))$,</div><div class="type_field">$\predLengthRoot$: $\abs{\h(\encS(\evolution{\lbl}{f}{\mathcal{S}}(\sequence{v, \nil})))}$,</div></div>}
<p>Otherwise, let $p$ be the predecessor of $v$, and let $s$ be the other out-neighbor of $v$ if one exists, or the predecessor of $v$ if $v$ has only one out-neighbor. Then:</p>
$\event{v} \defeq$ $\childEvent$ {<div class="type_body"><div class="type_field">$\depth$: $\depth{\evolution{G}{\lsthree}{\mathcal{S}}}(v)$,</div><div class="type_field">$\pred$: $\h(\eventEncoding{p})$,</div><div class="type_field">$\predChange$: $\h(\encS(\evolution{\lbl}{\lsthree}{\mathcal{S}}(\sequence{v, p})))$,</div><div class="type_field">$\predLength$: $\abs{\h(\encS(\evolution{\lbl}{\lsthree}{\mathcal{S}}(\sequence{v, p})))}$,</div><div class="type_field">$\skip$: $\h(\eventEncoding{s})$,</div><div class="type_field">$\skipChange$: $\h(\encS(\evolution{\lbl}{\lsthree}{\mathcal{S}}(\sequence{v, s})))$,</div><div class="type_field">$\skipLength$: $\abs{\h(\encS(\evolution{\lbl}{\lsthree}{\mathcal{S}}(\sequence{v, s})))}$,</div></div>}
</div>
<p>Data sources publish new additions to an <a href="#evolution" class="ref">evolution</a> in the form of <a href="#magma_event" class="ref">magma events</a>, and servers relay those <a href="#magma_event" class="ref">magma events</a> to clients. <a href="#magma_event" class="ref">Magma events</a> contain more than the bare minimum of data that would be necessary to reconstruct an <a href="#evolution" class="ref">evolution</a>. This additional data allows clients to detect malicious behavior in a server. The structure of their communication is described in the next section.</p>
</section>
<section class="section">
            <h3><a id="communication" href="#communication">Client-Server Communication</a></h3>
        <p>The general structure of the communication between client and server is that of the client making request and the server responding with <a href="#magma_event" class="ref">magma events</a> and <a href="#semigroup" class="ref">semigroup</a> values.</p>
<p>A request contains the hash of the <a href="#magma_event_encoding" class="ref">event encoding</a> for which the client wishes to obtain the accumulated value, as well as the hash of the most recent <a href="#magma_event" class="ref">magma event</a> the client has.</p>
<p>The server responds with the <a href="#magma_event" class="ref">magma events</a> along the shortest path from the requested event to the old event, supplying the client with enough metadata to verify the integrity of the <a href="#semigroup" class="ref">semigroup</a> values the server transmits afterwards. The request furthermore contains some parameters determining which <a href="#semigroup" class="ref">semigroup</a> values are to be transmitted, as well as some options for skipping parts of the event transfer in case some of that information is already available to the client.</p>
<p>We first give a precise definition of the data transmitted by the server.</p>
<div id="response" class="definition">
<h5><a href="#response">Definition <span class="chapterNumber">0.</span>10: Response</a></h5><p>A <a href="#response" class="defined">response</a> is an instance of the following datatype:</p>
$\newcommand{\response}[0]{\href{##response_type}{\type{Response}}}\newcommand{\unknownEvent}[0]{\href{##unknown_event}{\constructor{UnknownEvent}}}\newcommand{\data}[0]{\href{##data}{\constructor{Data}}}\newcommand{\events}[0]{\href{##events}{\field{events}}}\newcommand{\values}[0]{\href{##values}{\field{values}}}$<div class="comment">The data clients query for.</div>enum $\cssId{response_type}{\response}$ {<div class="type_body"><div class="comment">The server cannot serve a meaningful response, because it does not know about one of the <a href="#magma_event" class="ref">magma events</a> the client specified.</div>$\cssId{unknown_event}{\unknownEvent}$,<div class="comment"><a href="#magma_event" class="ref">Magma events</a> and <a href="#semigroup" class="ref">semigroup</a> values along the shortest path in the <a href="#evolution" class="ref">evolution</a> between the two <a href="#magma_event" class="ref">magma events</a> the client specified.</div>$\cssId{data}{\data}$ {<div class="type_body"><div class="comment">The <a href="#magma_event" class="ref">magma events</a> along the shortest path in the <a href="#evolution" class="ref">evolution</a> between the specified <a href="#magma_event" class="ref">magma events</a>.</div><div class="type_field">$\cssId{events}{\events}$: $\powerset{\magmaEvent}$</div><div class="comment">The <a href="#semigroup" class="ref">semigroup</a> values along the shortest path in the <a href="#evolution" class="ref">evolution</a> between the specified <a href="#magma_event" class="ref">magma events</a>.</div><div class="type_field">$\cssId{values}{\values}$: $\powerset{\S}$</div></div>}</div>}
</div>
<p>Regardless of the specifics of the communication protocol, a server sending a $\data$ <a href="#response" class="ref">response</a> first transmits the $\events$ in order of descending <a href="#depth" class="ref">depth</a>. The client hashes the first received <a href="#magma_event" class="ref">magma event</a> and verifies that the resulting digest matches the one it requested. For all further <a href="#magma_event" class="ref">magma events</a>, the client first verifies that the <a href="#depth" class="ref">depth</a> has the correct value (the correct position in the shortest path in the <a href="#evolution" class="ref">evolution</a>), and then computes the hash and verifies that it matches either the $\pred$ or $\skip$ of the preceding <a href="#magma_event" class="ref">magma event</a>, depending on whether the shortest path goes along a <a href="https://aljoscha-meyer.de/linkingschemes#predecessor_link" class="ref">predecessor link</a> or <a href="https://aljoscha-meyer.de/linkingschemes#skip_link" class="ref">skip link</a> respectively.</p>
<p>The <a href="#semigroup" class="ref">semigroup</a> $\values$ of the <a href="#response" class="ref">response</a> are transmitted sorted by the order of the <a href="#depth" class="ref">depths</a> of the associated <a href="#magma_event" class="ref">magma events</a>. Whether they are sorted in ascending or descending order is specified by the client. When the client receives a <a href="#semigroup" class="ref">semigroup</a> value, it verifies that its hash and length exactly match the ones given in the corresponding <a href="#magma_event" class="ref">magma event</a>.</p>
<p>If a <a href="#semigroup" class="ref">semigroup</a> value $s$ has to be transmitted but the corresponding <a href="#magma_event" class="ref">magma event</a> $e$ has not yet been transmitted, that <a href="#magma_event" class="ref">magma event</a> is transmitted first — otherwise the client cannot detect if a malicious server feeds it garbage data rather than an appropriate value. This however does not help if the client cannot verify that $e$ is a non-fabricated <a href="#magma_event" class="ref">magma event</a>. Thus, if the client has not yet received a <a href="#magma_event" class="ref">magma event</a> whose $\pred$ or $\skip$ is the hash of $e$, the server must instead transmit the <a href="#magma_event" class="ref">magma events</a> along the shortest possible path from a <a href="#magma_event" class="ref">magma event</a> that has already been transmitted to $e$ (in order of descending <a href="#depth" class="ref">depths</a>).</p>
<p>We now define the options a client has to specify which data it is interested in:</p>
<div id="request" class="definition">
<h5><a href="#request">Definition <span class="chapterNumber">0.</span>11: Request</a></h5><p>$\newcommand{\Mode}[0]{\href{##Mode}{\type{Mode}}}
                        \newcommand{\payloadNone}[0]{\href{##payload_none}{\value{None}}}
                        \newcommand{\payloadAscending}[0]{\href{##payload_ascending}{\value{Asc}}}
                        \newcommand{\payloadDescending}[0]{\href{##payload_descending}{\value{Desc}}}
                        \newcommand{\payloadAllAscending}[0]{\href{##payload_all_ascending}{\value{AllAsc}}}
                        \newcommand{\payloadAllDescending}[0]{\href{##payload_all_descending}{\value{AllDesc}}}$A <a href="#request" class="defined">request</a> is an instance of the following datatype:</p>
$\newcommand{\request}[0]{\href{##request_type}{\type{Request}}}\newcommand{\from}[0]{\href{##from}{\field{from}}}\newcommand{\reqto}[0]{\href{##to}{\field{to}}}\newcommand{\mode}[0]{\href{##mode}{\field{mode}}}\newcommand{\offsetEvent}[0]{\href{##event_offset}{\field{offset_{\mathit{event}}}}}\newcommand{\offsetValue}[0]{\href{##value_offset}{\field{offset_{\mathit{value}}}}}$<div class="comment">Describes which data the client wants from the server.</div>struct $\cssId{request_type}{\request}$ $\{$<div class="type_body"><div class="comment">The hash of the latest <a href="#magma_event" class="ref">magma event</a> for which the client already knows the accumulated value.</div><div class="type_field">$\cssId{from}{\from}$: $\digest$</div><div class="comment">The hash of the <a href="#magma_event" class="ref">magma event</a> for which the client wants to obtain the accumulated value.</div><div class="type_field">$\cssId{to}{\reqto}$: $\digest$</div><div class="comment">Specifies which <a href="#semigroup" class="ref">semigroup</a> values are of interest to the client, and in which order they should be transmitted.
                                    <ul>
                                        <li>$\payloadNone$: no <a href="#semigroup" class="ref">semigroup</a> values at all</li>
                                        <li>$\payloadAscending$: the labels along the shortest path from $\reqto$ to $\from$, in order of ascending <a href="#depth" class="ref">depth</a></li>
                                        <li>$\payloadDescending$: the labels along the shortest path from $\reqto$ to $\from$, in order of descending <a href="#depth" class="ref">depth</a></li>
                                        <li>$\payloadAllAscending$: the labels along the <em>longest</em> path from $\reqto$ to $\from$, in order of ascending <a href="#depth" class="ref">depth</a></li>
                                        <li>$\payloadAllDescending$: the labels along the <em>longest</em> path from $\reqto$ to $\from$, in order of descending <a href="#depth" class="ref">depth</a></li>
                                    </ul></div><div class="type_field">$\cssId{mode}{\mode}$: $\Mode \defeq \set{\cssId{payload_}{\payloadNone}, \cssId{payload_ascending}{\payloadAscending}, \cssId{payload_descending}{\payloadDescending}, \cssId{payload_all_ascending}{\payloadAllAscending}, \cssId{payload_all_descending}{\payloadAllDescending}}$</div><div class="comment"></div><div class="type_field">$\cssId{event_offset}{\offsetEvent}$: $\UnsignedInteger{64}$</div><div class="comment"></div><div class="type_field">$\cssId{value_offset}{\offsetValue}$: $\UnsignedInteger{64}$</div></div>$\}$
</div>
<p>Intuitively, $\to$ specifies the point in the <a href="#evolution" class="ref">evolution</a> to which the client wants to update, and $\from$ indicates the depth of the most recent value that the client already has. $\fromName$ allows the client to optionally include the hash of that value, so that in case of a mismatch the server will not waste bandwidth on transmitting values which are of no use to the client. This is a safeguard against the client having received an invalid hash. The $\requestMode$ lets the client specify which <a href="#semigroup" class="ref">semigroup</a> values it wants to receive: none at all, the minimum amount of values in either ascending or descending order, or the full step-by-step changes (ideal for server-to-server synchronization). $\eventOffset$ and $\payloadOffset$ make the server skip over the beginning of a response, enabling efficient continuation after a communication channel mid-transmission failure.</p>
<p>We now describe how to map <a href="#request" class="ref">request</a> to <a href="#response" class="ref">responses</a> more formally. Let $\evolution{E}{\lsthree}{\SM} = \sequence{\evolution{G}{\lsthree}{\SM} = (\evolution{V}{\lsthree}{\SM}, \evolution{A}{\lsthree}{\SM}), \evolution{\lbl}{\lsthree}{\SM}}$ be an <a href="#evolution" class="ref">evolution</a>, let $U \subseteq \evolution{V}{\lsthree}{\SM}$, and let $T \subseteq \S$. We consider a server that holds the set of <a href="#magma_event" class="ref">magma events</a> $E \defeq \set{\event{u} \mid u \in U}$ and the set of <a href="#semigroup" class="ref">semigroup</a> values $T$.</p>
<p>When the server receives a <a href="#request" class="ref">request</a> $\sequence{\to, \from, \fromName, \requestMode, \eventOffset, \payloadOffset = \sequence{\mathit{len}, \mathit{hash}}}$, it checks whether there is $e \in E$ such that $\h(e) = \to$. If there is not, the <a href="#response" class="ref">response</a> is $\nil$. Otherwise let $v$ be the vertex with $\event{v} = e$. The server then proceeds by computing the sequence of <a href="#magma_event" class="ref">magma events</a> it will respond with.</p>
<p>If $\from > \depth{v}{\evolution{G}{\lsthree}{\SM}}$, the response consists of two empty sequences. Otherwise, let $u$ be the vertex in $\evolution{V}{\lsthree}{\SM}$ such that $\depth{u}{\evolution{G}{\lsthree}{\SM}} = \from$ and $u \ancestor{\evolution{G}{\lsthree}{\SM}} v$. Let $\sequence{v_0 = v, v_1, \ldots, v_k = u}$ be the shortest path from $v$ to $u$. Let $l < k$ be the greatest number such that all <a href="#magma_event" class="ref">magma events</a> in $L \defeq \sequence{\event{v_{\eventOffset}}, \event{v_{\eventOffset + 1}}, \ldots, v_{l}}$ are in $U$. Then $L$ is the sequence of <a href="#magma_event" class="ref">magma events</a> in the <a href="#response" class="ref">response</a>.</p>
<p>The sequence of elements from $\S$ in the <a href="#response" class="ref">response</a> is the empty sequence if $\requestMode = \payloadNone$ or if $\fromName \neq \nil$ and $\fromName \neq \eventEncoding{u}$.</p>
<p>If $\requestMode = \payloadDescending$ or $\requestMode = \payloadAscending$, let $j \leq l$ be the greatest number such that all members of the sequence $J \defeq \sequence{\evolution{\lbl}{\lsthree}{\SM}(\sequence{v_0, v_1}), \evolution{\lbl}{\lsthree}{\SM}(\sequence{v_1, v_2}), \ldots, \evolution{\lbl}{\lsthree}{\SM}(\sequence{v_j, v_{j + 1}})}$ are in $T$.</p>
<p>If $\requestMode = \payloadDescending$, then $J$ is the sequence of elements from $\S$ in the <a href="#response" class="ref">response</a>. If $\requestMode = \payloadAscending$, it is the reversed sequence $\sequence{\evolution{\lbl}{\lsthree}{\SM}(\sequence{v_j, v_{j + 1}}), \ldots, \evolution{\lbl}{\lsthree}{\SM}(\sequence{v_0, v_1})}$.</p>
<p>Otherwise, if $\requestMode = \payloadAll$, let $\sequence{t_0 = v, t_1, \ldots, t_n = u}$ be the <em>longest</em> path from $v$ to $u$. Let $m \leq n$ be the greatest number such that all members of the sequence $J \defeq \sequence{\evolution{\lbl}{\lsthree}{\SM}(\sequence{t_0, t_1}), \evolution{\lbl}{\lsthree}{\SM}(\sequence{t_1, t_2}), \ldots, \evolution{\lbl}{\lsthree}{\SM}(\sequence{t_m, t_{m + 1}})}$ are in $T$. Then $M$ is the sequence of elements from $\S$ in the <a href="#response" class="ref">response</a>.</p>
<p>The $\payloadOffset$ is ignored unless $\eventOffset \geq k$, in which case the server computes the hash over the first $\mathit{len}$ bytes of the encoding of the first <a href="#semigroup" class="ref">semigroup</a> value to be transmitted. If that hash is equal to $\mathit{hash}$, the transmission begins at byte $\mathit{len}$ (zero-indexed), otherwise the value is transmitted as normal.</p>
<p>When receiving a response, the client verifies the integrity of the data that receives. For the first <a href="#magma_event_encoding" class="ref">event encoding</a> it receives, it checks whether it matches the expected hash. For all further <a href="#magma_event_encoding" class="ref">event encodings</a> it verifies that its depth is the expected one, and that it hashes to the hash specified in the previous <a href="#magma_event" class="ref">magma event</a>.</p>
<p>When receiving encoded <a href="#semigroup" class="ref">semigroup</a> values, the client verifies that they have exactly the length and hash promised in the corresponding <a href="#magma_event" class="ref">magma event</a>.</p>
</section>
<section class="section">
            <h3><a id="transmission_protocol" href="#transmission_protocol">Transmission Protocol</a></h3>
        <p>To allow for concurrent requests, the protocol is an instantiation of <a href="https://github.com/AljoschaMeyer/reqres" class="outlink">reqres</a> static request and streaming responses.</p>
<p>Request are encoded beginning with a byte of flags: the four most significant bits should be set to zero and are ignored during decoding, the fifth bit is set to one iff $\eventOffset \neq 0$, the sixth bit is set to one iff $\fromName \neq \nil$, and the seventh and eighth bit encode the $\requestMode$: $00$ for $\payloadNone$, $01$ for $\payloadAscending$, $10$ for $\payloadDescending$, and $11$ for $\payloadAll$.</p>
<p>This initial byte is followed by $\to$, followed by $\from$ encoded as a <a href="https://github.com/AljoschaMeyer/varu64" class="outlink">VarU64</a>, followed by $\fromName$ if $\fromName \neq \nil$. If $\eventOffset \neq 0$, this is followed by $\eventOffset$ encoded as a <a href="https://github.com/AljoschaMeyer/varu64#non-zero-unsigned-integers" class="outlink">VarNonZeroU64</a>.</p>
<p>Finally, if $\eventOffset$ is large enough that the <a href="#response" class="ref">response</a> will not contain any <a href="#magma_event" class="ref">magma events</a> even if the server had all events that exist, this is followed by the 64-bit integer part of the $\payloadOffset$ encoded as a <a href="https://github.com/AljoschaMeyer/varu64" class="outlink">VarU64</a>, and if that is nonzero, that is followed by the hash part of the $\payloadOffset$.</p>
<p>A $\nil$ <a href="#response" class="ref">response</a> is transmitted as zero byte for the first response item, and the unit type for the last response item (there are no repeated response items). If the response is not $\nil$ but both sequences are empty, the server may act as if the response was $\nil$, since this is more efficient to encode yet the client does not lose out on information.</p>
<p>Otherwise let $\sequence{e, s}$ be the sequences of <a href="#magma_event" class="ref">magma events</a> and <a href="#semigroup" class="ref">semigroup</a> values respectively. The first response item is the byte $0x01$. The repeated response items are the bytes of the encodings of the <a href="#magma_event" class="ref">magma events</a> in $e$ (in sequence order), followed by the bytes of the encodings of the values in $s$ (in sequence order). The last response item is the unit type.</p>
<p>If the response contained a $\payloadOffset = \sequence{\mathit{len}, \mathit{hash}}$, the server computes the hash over the first $\mathit{len}$ bytes of the encoding of the first <a href="#semigroup" class="ref">semigroup</a> value in $s$. If it matches $\mathit{hash}$, the first response item is the byte $0x02$ and the first $\mathit{len}$ bytes of the encoding of the first value of $s$ are omitted from the response.</p>
<p>If in the request $\requestMode = \payloadAll$, the encoding of each <a href="#semigroup" class="ref">semigroup</a> value whose corresponding <a href="#magma_event" class="ref">magma event</a> has not yet been transmitted in the response, is preceded by the encoding of its corresponding <a href="#magma_event" class="ref">magma event</a>.</p>
</section>
<section class="section">
            <h3><a id="logs" href="#logs">Hashing free monoids</a></h3>
        <p>TODO</p>
</section>
<section class="section">
            <h3><a id="lava" href="#lava">Lava</a></h3>
        <p>A <a href="#request" class="ref">request</a> has to specify the hash of the <a href="#magma_event" class="ref">magma event</a> to which it wants to update to. Lava extends magma with the powerful option of requesting new events without knowing their hash in advance. The basic idea is that specifying the hash of a well-known event $e$ of depth $d$ together with an depth offset $o$ is unambiguous if there is at most one event $v$ of depth $d + o$ with $e \ancestor{} v$. In case of ambiguity, the server can transmit data up until the first point of ambiguity.</p>
<p>If servers indiscriminately store all new events, regardless of the data source, then it becomes unlikely that any offset-based request is unambiguous. Lava introduces the concept of authorship so that a data source can ensure that offset-based requests can always be served, by producing at most one successor event per event.</p>
<p>$\newcommand{\sign}[0]{\href{##sign}{\mathit{sign}}}\newcommand{\verify}[0]{\href{##verify}{\mathit{verify}}}$Authorship is implemented by signing all events with a <a href="https://en.wikipedia.org/wiki/Digital_signature" class="outlink">digital signature</a>. An instantiation of the lava protocol must fix a signature scheme, we write $\sign$ for the signing function and $\verify$ for the verification function.</p>
</section>
<section class="section">
            <h3><a id="metadata" href="#metadata">Ordered Metadata</a></h3>
        <p>Offset-based requests are not the only way for requesting unknown data. An alternative is to specify a maximum payload size and then receive data until the total size of the encodings of <a href="#semigroup" class="ref">semigroup</a> values reaches that number.</p>
<p>We can generalize this by regarding the encoding size as a particular type of metadata. A different example for metadata could be the time that has passed since creating the previous entry. This would allow queries based on time windows.</p>
<p>Other types of metadata can be defined as well, the important part is that the value is strictly increasing, so that a server has always at most one point at which it should end the response. It must also be possible to aggregate the metadata within the events, so there must be an associative function for combining metadata entries.</p>
<div id="total_order" class="definition">
<h5><a href="#total_order">Definition <span class="chapterNumber">0.</span>12: Total order</a></h5><div class="assumptionsmulti">Let $S$ be a set and $R \subseteq S \times S$.</div><p>We call $R$ a  <a href="#total_order" class="defined">total order</a> if it satisfies the following properties:</p>
<ul>
                            <li><a id="total_order_reflexivity" href="#total_order_reflexivity" class="defined">reflexivity</a>: For all $x \in S$ it holds that $\sequence{x, x} \in R$.</li>
                            <li><a id="total_order_antisymmetry" href="#total_order_antisymmetry" class="defined">antisymmetry</a>: For all $x, y \in S$ it holds that if $\sequence{x, y} \in R$ and $\sequence{y, x} \in R$, then $x = y$.</li>
                            <li><a id="total_order_transitivity" href="#total_order_transitivity" class="defined">transitivity</a>: For all $x, y, z \in S$ it holds that if $\sequence{x, y} \in R$ and $\sequence{y, z} \in R$, then $\sequence{x, z} \in R$.</li>
                            <li><a id="total_order_totality" href="#total_order_totality" class="defined">totality</a>: For all $x, y \in S$ it holds that $\sequence{x, y} \in R$ or $\sequence{y, x} \in R$.</li>
                        </ul>
</div>
<div id="ordered_semigroup" class="definition">
<h5><a href="#ordered_semigroup">Definition <span class="chapterNumber">0.</span>13: Ordered semigroup</a></h5><p>An <a href="#ordered_semigroup" class="defined">ordered semigroup</a> is a <a href="#semigroup" class="ref">semigroup</a> $\sequence{S, \groupAdd}$ and a <a href="#total_order" class="ref">total order</a> $R \subseteq S \times S$ such that for all $x, y \in S$ it holds that $\sequence{x, x \groupAdd y} \in R$.</p>
</div>
<p>$\newcommand{\k}[0]{\href{##k}{k}}\newcommand{\encM}[1]{\href{##encM}{\enc_{M_{#1}}}}$Lava cannot anticipate all possible needs for metadata, so it is generic over the metadata it supports. An instantiation of the protocol must fix a family $\mathcal{M}$ of $\k$ <a href="#ordered_semigroup" class="ref">ordered semigroups</a> $\sequence{\mathcal{M}_i = \sequence{M_i, \groupAdd_i}}, 1 \leq i \leq \k$ that describe the metadata attached to each event. Furthermore, it must be possible to encode metadata values as bit-strings, an instantiation must specify an injective encoding function $\fun{\cssId{encM}{\encM{i}}}{M_{i}}{\bitstring}$ for $1 \leq i \leq \k$.</p>
</section>
<section class="section">
            <h3><a id="lava_data" href="#lava_data">Lava data structures</a></h3>
        <p>With those concepts introduced, we can give the formal definitions that underlie lava. Everything starts with a <a href="#labeled_forest" class="ref">labeled in-forest</a>, but every vertex also holds $\k$ pieces of metadata.</p>
<div id="labeled_forest_lava" class="definition">
<h5><a href="#labeled_forest_lava">Definition <span class="chapterNumber">0.</span>14: Labeled In-Forest With Metadata</a></h5><p>$\newcommand{\metadata}[0]{\href{##metadata}{\mathit{metadata}}}$A <a href="#labeled_forest_lava" class="defined">labeled in-forest with metadata</a> is a tuple $\sequence{G, \lbl, \metadata}$, where $\sequence{G = (V, A), \lbl}$ is a <a href="#labeled_forest" class="ref">labeled in-forest</a>, and $\metadata = (\fun{\metadata_i}{V}{M_i}, 1 \leq i \leq \k)$ is a family of functions assigning metadata to each vertex.</p>
</div>
<p>Next, we extend the concept of an <a href="#evolution" class="ref">evolution</a> with additional arc labels for each piece of metadata.</p>
<div id="evolution" class="definition">
<h5><a href="#evolution">Definition <span class="chapterNumber">0.</span>15: Evolution with metadata</a></h5><div class="assumptionsmulti">$\newcommand{\associatedGraph}[1]{\href{https://aljoscha-meyer.de/linkingschemes##associated_graph}{G}_{#1}}$Let $\mathcal{S} = \sequence{S, \groupAdd}$ be a <a href="#semigroup" class="ref">semigroup</a>, $\mathcal{F} = \sequence{G = \sequence{V, A}, \fun{\lbl}{V}{S}, \metadata}$ a <a href="#labeled_forest_lava" class="ref">labeled in-forest with metadata</a>, and $\fun{f}{\Np}{\Np}$ be a function such that $\associatedGraph{f}$ is a <a href="https://aljoscha-meyer.de/linkingschemes#bamls" class="ref">binary anti-monotone linking scheme</a>.</div><p>$\newcommand{\evolutionLava}[4]{{#1}_{\sequence{{#2}, {#3}, {#4}}}}$An $\sequence{f, \mathcal{S}, \mathcal{M}}$-<a id="evolution_lava" href="#evolution_lava" class="defined">evolution with metadata</a> of $\mathcal{F}$ is an arc-labeled directed graph with multiple labeling functions $\evolutionLava{E}{f}{\mathcal{S}}{\mathcal{M}} \defeq \sequence{\evolutionLava{G}{f}{\mathcal{S}}{\mathcal{M}} = (\evolutionLava{V}{f}{\mathcal{S}}{\mathcal{M}}, \evolutionLava{A}{f}{\mathcal{S}}{\mathcal{M}}), \evolutionLava{\lbl}{f}{\mathcal{S}}{\mathcal{M}}, \evolutionLava{\metadata}{f}{\mathcal{S}}{\mathcal{M}}}$, such that:</p>
<p>$\sequence{\evolutionLava{G}{f}{\mathcal{S}}{\mathcal{M}}, \evolutionLava{\lbl}{f}{\mathcal{S}}{\mathcal{M}}}$ is a $\sequence{f, \mathcal{S}}$-<a href="#evolution" class="ref">evolution</a></p>
<p>and $\evolutionLava{\metadata}{f}{\mathcal{S}}{\mathcal{M}} = (\fun{{\evolutionLava{\metadata}{f}{\mathcal{S}}{\mathcal{M}}}_i}{\evolutionLava{A}{f}{\mathcal{S}}{\mathcal{M}}}{M_i}, 1 \leq i \leq \k)$ is a family of functions such that for all $\sequence{v, u} \in \evolution{A}{f}{\mathcal{S}}$, $\metadata_i(u) \groupAdd_i \evolutionLava{\metadata_i}{f}{\mathcal{S}}{\mathcal{M}}(\sequence{v, u}) = \metadata_i(v)$.</p>
</div>
<p>Now, we can specify the pieces of data by which data sources produce such <a href="#evolution_lava" class="ref">evolutions with metadata</a>. This is where signatures enter the picture.</p>
<div id="lava_event" class="definition">
<h5><a href="#lava_event">Definition <span class="chapterNumber">0.</span>16: Lava Event</a></h5><p>$\newcommand{\rootEventLava}[3]{\href{##root_event_lava}{\value{RootEvent}}\sequence{{#1}, {#2}, m_1, \ldots, m_{\k}, {#3}}}\newcommand{\childEventLava}[8]{\href{##child_event_lava}{\value{ChildEvent}}\sequence{{#1}, {#2}, {#3}, {#4}, {#5}, {#6}, {#7}, m_1, \ldots, m_{\k}, {#8}}}\newcommand{\sig}[0]{s}$A <a href="#lava_event" class="defined">lava event</a> is either a <a id="root_event_lava" href="#root_event_lava" class="defined">root event</a> $\rootEventLava{\predChange}{\len{\predChange}}{\sig}$ or a <a id="child_event_lava" href="#child_event_lava" class="defined">child event</a> $\childEventLava{\time}{\predChange}{\len{\predChange}}{\pred}{\skipChange}{\len{\skipChange}}{\skip}{\sig}$, where $\time, \len{\predChange}, \len{\skipChange}$ are unsigned 64-bit integers, and $\predChange, \skipChange, \pred, \skip, m_1 \in M_1, \ldots, m_{\k}, \sig \in \bitstring$.</p>
</div>
<p>I need to settle the better notation for data types, so just sketching things for now:</p>
<p>You encode a <a href="#lava_event" class="ref">lava event</a> just like a <a href="#magma_event" class="ref">magma event</a>, followed by the encodings of the metadata (not their hashes but their actual values), followed by the signature over all the previous data.</p>
<p>Lava responses work identically to magma responses.</p>
<p>Lava requests are like magma requests, but instead of specifying the hash of a target event, they can instead specify a maximum change for the sequence number, accumulated payload size, and accumulated metadata (for each metadata value separately ). The corresponding response then contains events until the first event which exceeds at least one of those values. Such requests also include a flag to indicate whether the request asks for ancestors or descendents. Such requests also include a public key, the server ignores all of its events which have not been signed by that public key. The response ends whenever an event is reached which has more than one successor of the correct public key (i.e. a fork), the response does include the hashes of all of those possible successor events.</p>
</section>

</html>
